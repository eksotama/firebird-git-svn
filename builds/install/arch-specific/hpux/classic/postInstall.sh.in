#!/bin/sh
#
#  This library is part of the Firebird project
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#  You may obtain a copy of the Licence at
#  http://www.gnu.org/licences/lgpl.html
#  
#  As a special exception this file can also be included in modules
#  with other source code as long as that source code has been 
#  released under an Open Source Initiative certificed licence.  
#  More information about OSI certification can be found at: 
#  http://www.opensource.org 
#  
#  This module is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Lesser General Public Licence for more details.
#  
#  This module was created by members of the firebird development 
#  team.  All individual contributions remain the Copyright (C) of 
#  those individuals and all rights are reserved.  Contributors to 
#  this file are either listed below or can be obtained from a CVS 
#  history command.
# 
#   Created by:  Mark O'Donohue <mark.odonohue@ludwig.edu.au>
# 
#   Contributor(s):
#  
# 
#   $Id: postInstall.sh.in,v 1.3 2008-01-10 11:26:54 paulbeach Exp $
# 

# The post install script for Firebird Classic

    # Make sure the links are in place 
    if  [ -z "$FirebirdInstallPrefix" ]
       then
        FirebirdInstallPrefix=@prefix@
	ln -s @prefix@/lib/libfbembed.sl.@FIREBIRD_VERSION@ @prefix@/lib/libfbembed.sl.2
	ln -s @prefix@/lib/libfbembed.sl.2 @prefix@/lib/libfbemebed.sl
	ln -s @prefix@/lib/libfbembed.sl.@FIREBIRD_VERSION@ @libdir@/libfbembed.sl.@FIREBIRD_VERSION@
	ln -s @prefix@/lib/libfbembed.sl.2 @libdir@/libfbembed.sl.2
	ln -s @prefix@/lib/libfbembed.sl @libdir@/libfbembed.sl
	ln -s @prefix@/lib/libfbclient.sl.@FIREBIRD_VERSION@ @prefix@/lib/libfbclient.sl.2
	ln -s @prefix@/lib/libfbclient.sl.2 @prefix@/lib/libfbclient.sl
	ln -s @prefix@/lib/libfbclient.sl.@FIREBIRD_VERSION@ @libdir@/libfbclient.sl.@FIREBIRD_VERSION@
	ln -s @prefix@/lib/libfbclient.sl.2 @libdir@/libfbclient.sl.2
	ln -s @prefix@/lib/libfbclient.sl @libdir@/libfbclient.sl
	ln -s @prefix@/lib/libicudata.sl.30.0 @prefix@/lib/libicudata.sl.30
	ln -s @prefix@/lib/libicudata.sl.30 @prefix@/lib/libicudata.sl
	ln -s @prefix@/lib/libicui18n.sl.30.0 @prefix@/lib/libicui18n.sl.30
	ln -s @prefix@/lib/libicuuc.sl.30 @prefix@/lib/libicuuc.sl
	ln -s @prefix@/lib/libicuuc.sl.30.0 @prefix@/lib/libicuuc.sl.30
	ln -s @prefix@/lib/libib_util.sl @libdir@/libib_util.sl
	ln -s @prefix@/lib/libicui18n.sl.30 @prefix@/lib/libicui18n.sl
    fi

    origDir=`pwd`

    # Update /etc/services

    # The \n is needed, some /etc/services files are missing a trailing
    # line feed - MOD 7-Nov-2002
    FileName=/etc/services
    newLine="gds_db          3050/tcp  # Firebird SQL Database Remote Protocol"
    oldLine=`grep "^gds_db" $FileName`
    if [ -z "$oldLine" ]
      then
        echo "" >> $FileName
        echo $newLine >> $FileName
        echo "" >> $FileName
    #    replaceLineInFile "$FileName" "$newLine" "$oldLine"
    fi

    updateHostsDotFile

    # add Firebird user
    if [ $RunUser = "firebird" ]
      then
        addFirebirdUser
    fi


    # Create Lock files
    cd $FBRootDir

    for i in isc_init1 isc_lock1 isc_event1 
      do
        FileName=$i.`hostname`
        touch $FileName
      done

    # Create log
    touch firebird.log


    # Update ownership and SUID bits for programs.
    chown -R $RunUser $FBRootDir
    chgrp -R $RunUser $FBRootDir

    fixFilePermissions
    # Correct a couple of minor issues set via FilePermissions
    chmod 666 security2.fdb
    chmod 666 isc_lock1.`hostname`
    echo "Updating Lock Manager"
    cd $FBBin
    for i in fb_lock_mgr
    do
	if [ -f $i ]
	then
		chown root $i
		chmod ug=rx,o= $i
		chmod ugo+s $i
		fi
	done	

    
    createLinksForBackCompatibility

    buildUninstallFile

    # Update the /etc/inetd.conf or xinetd entry
    updateInetdServiceEntry


    # Get inetd to reread new init files.
    resetInetdServer


    cd $FBRootDir
    
    # Change sysdba password
    changeDBAPassword



